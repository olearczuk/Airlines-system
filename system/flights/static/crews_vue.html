<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
</head>
<body>
    <div id="app">
        <a href="/">Main page</a>
        <br><br>

        <crew-creator v-on:post-crew="postCrew($event)"></crew-creator>
        <table>
            <tr>
                <th>Flight</th>
                <th><span style="color:red">&#9992;</span> nr</th>
                <th>Departure time</th>
                <th>Arrival time</th>
                <th>Current crew</th>
            </tr>
            <tr v-for="flight in flights">
                <td>
                    {{ flight.start_airport.city }}({{ flight.start_airport.country }})
                    <span style="color:red">&#8658;</span>
                    {{ flight.final_airport.city }}({{ flight.final_airport.country }})
                    <br/>
                    <crew-picker
                        v-on:patch-crew="patchCrew($event)"
                        v-bind:crews='crews'
                        v-bind:flight='flight'
                    ></crew-picker>
                </td>
                <td>{{ flight.airplane.official_number }}</td>
                <td>{{ formatDate(flight.departure_time) }}</td>
                <td>{{ formatDate(flight.arrival_time) }}</td>
                <td>{{ crewName(flight.crew) }}</td>
            </tr>
        </table>
     </div>

     <script>
        Vue.component('crew-picker', {
            props:['crews', 'flight'],
            data() {
                return {
                    selectedCrew: '',
                }
            },
            template: `
                <div class='crew-picker'>
                    <select v-model="selectedCrew">
                    <option value="">Choose crew</option>
                        <option v-for="crew in crews" v-bind:value="crew.id">
                            {{crew.captainsName + " " + crew.captainsSurname}}
                        </option>
                    </select>
                    <button v-on:click="pom">Submit</button>
                </div>
            `,
            methods: {
                pom: function () {
                    if (this.selectedCrew === '')
                        alert('Choose crew before submitting!')
                    else
                        this.$emit('patch-crew', {
                            "crew": this.selectedCrew,
                            "flight": this.flight
                        })
                        
                }
            }

        })

        Vue.component('crew-creator', {
            data() {
                return {
                    captainsName: '',
                    captainsSurname: '',
                }
            },
            template: `
                <div class="crew-creator">
                    captain's name: <br> <input v-model='captainsName' type="text"> <br>
                    captain's surname: <br> <input v-model='captainsSurname' type="text"> <br><br>
                    <button v-on:click='submit'>Submit</button>
                </div>
            `,
            methods: {
                submit: function () {
                        this.$emit('post-crew', {
                            "captainsName": this.captainsName, 
                            "captainsSurname": this.captainsSurname
                        })
                }

            }
        })


        var app = new Vue({
            el: '#app',
            data: {
                flights: [],
                crews: [],
                api_root: '/api/',
            },
            created() {
                let url = this.api_root + 'flights.json'

                fetch(url)
                    .then((response) => response.json())
                    .then((response) => {
                        this.flights = response
                        console.log('flights', this.flights)
                    })
                    .catch((error) => {
                        console.log(error);
                    })
               
                url = this.api_root + 'crew.json'
                fetch(url)
                    .then((response) => response.json())
                    .then((response) => {
                        this.crews = response
                        console.log('crews', this.crews)
                    })
                    .catch((error) => console.log(error))

            },
            methods: {
                formatDate: function (date) {
                    let options = {  
                        year: "numeric", month: "short",  
                        day: "numeric", hour: "2-digit", minute: "2-digit"  
                    }
                    date = new Date(date)
                    toLocale = date.toLocaleDateString("en-US", options)
                    console.log(toLocale)
                    return toLocale
                },
                getCookie: function (name) {
                    let value = "; " + document.cookie;
                    let parts = value.split("; " + name + "=");
                    if (parts.length == 2) return parts.pop().split(";").shift();
                },
                crewName: function (crew_id) {
                    if (crew_id === null)
                        return ''
                    let crew
                    for (crew of this.crews)
                        if (crew.id === crew_id)
                            return crew.captainsName + " " + crew.captainsSurname
                },
                patchCrew: function (data) {
                    let csrftoken = this.getCookie('csrftoken')
                    let flight = data.flight
                    console.log(flight, this.flights.indexOf(flight))
                    let crew = data.crew
                    let url = this.api_root + 'flights/' + flight.id + '/'
                    if (crew != flight.crew) {
                        let fetchData = {
                            method: 'PATCH',
                            body: JSON.stringify({
                                "crew": crew
                            }),
                            credentials: 'same-origin',
                            headers: {
                                'content-type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                        }
                        fetch(url, fetchData)
                            .then((response) => {
                                if (response.status === 400)
                                    alert("This crew is busy!")
                                if (response.status === 401)
                                    alert("You need to bo logged in to set crew. Head to localhost:8000/auth/login.")
                                if (response.ok === false)
                                    return ''
                                console.log(response)
                                if (response.redirected)
                                    window.location.replace(response.url)
                                return response.json()
                            })
                            .then((data) => {
                                if (data != '') {
                                    newFlight = flight
                                    newFlight.crew = crew
                                    Vue.set(this.flights, this.flights.indexOf(flight), newFlight)
                                }
                            })
                            .catch((error) => console.log(error))
                        }

                },
                postCrew: function(data) {
                    if (data.captainsName === '' || data.captainsSurname === '')
                        alert('Make sure to write both name and surname!')
                    let csrftoken = this.getCookie('csrftoken')
                    let url = this.api_root + 'crew/'      

                    let fetchData = {
                            method: 'POST',
                            body: JSON.stringify({
                                "captainsName": data.captainsName,
                                "captainsSurname": data.captainsSurname,
                            }),
                            credentials: 'same-origin',
                            headers: {
                                'content-type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                        }

                    fetch(url, fetchData)
                        .then((response) => {
                            console.log(response)
                            if (response.status === 400)
                                alert("This name and surname are already in use!")
                            if (response.status === 401)
                                alert("You need to bo logged in to create new crew. Head to localhost:8000/auth/login.")
                            if (response.ok === false)
                                return ''
                            return response.json()
                        })
                        .then((data) => {
                            console.log("data", data)
                            if (data != '')
                                this.crews.push(data)
                        })
                        .catch((error) => console.log(error))
                }
            }
        })
     </script>
        <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }

        @media only screen and (max-width: 760px),
        (min-device-width: 768px) and (max-device-width: 1024px){
            table, thead, tbody, th, td, tr {
                display: block;
            }
            td, th {
                text-align: left;
                border: none;
                border-bottom: 1px solid #dddddd;
                position: relative;
                padding-left: 20%;
            }
        }

    </style>
</body>
</html>