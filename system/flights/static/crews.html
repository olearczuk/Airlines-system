<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crew</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
</head>
<body>
    <div id="app">
        <a href="/">Main page</a>
        <br><br>

        <crew-creator v-on:post-crew="postCrew($event)"></crew-creator>
        <table>
            <tr>
                <th>Flight</th>
                <th><span style="color:red">&#9992;</span> nr</th>
                <th>Current crew</th>
            </tr>
            <tr v-for="flight in flights">
                <td>
                    {{ flight.start_airport.city }}({{ flight.start_airport.country }})
                    <span style="color:red">&#8658;</span>
                    {{ flight.final_airport.city }}({{ flight.final_airport.country }})
                    <br/>
                    <crew-picker
                        v-on:patch-crew="patchCrew($event)"
                        v-bind:crews='crews'
                        v-bind:flight='flight'
                    ></crew-picker>
                </td>
                <td>{{ flight.airplane.official_number }}</td>
                <td>{{crewName(flight.crew)}}</td>
            </tr>
        </table>
     </div>

     <script>
        Vue.component('crew-picker', {
            props:['crews', 'flight'],
            data() {
                return {
                    selectedCrew: '',
                }
            },
            template: `
                <div class='crew-picker'>
                    <select v-model="selectedCrew">
                    <option value="">Choose crew</option>
                        <option v-for="crew in crews" v-bind:value="crew.id">
                            {{crew.captainsName + " " + crew.captainsSurname}}
                        </option>
                    </select>
                    <button v-on:click="pom">Submit</button>
                </div>
            `,
            methods: {
                pom: function () {
                    if (this.selectedCrew === '')
                        alert('Choose crew before submitting!')
                    else
                        this.$emit('patch-crew', {
                            "crew": this.selectedCrew,
                            "flight": this.flight
                        })
                        
                }
            }

        })

        Vue.component('crew-creator', {
            data() {
                return {
                    captainsName: '',
                    captainsSurname: '',
                }
            },
            template: `
                <div class="crew-creator">
                    captain's name: <br> <input v-model='captainsName' type="text"> <br>
                    captain's surname: <br> <input v-model='captainsSurname' type="text"> <br><br>
                    <button v-on:click='submit'>Submit</button>
                </div>
            `,
            methods: {
                submit: function () {
                        this.$emit('post-crew', {
                            "captainsName": this.captainsName, 
                            "captainsSurname": this.captainsSurname
                        })
                }

            }
        })


        var app = new Vue({
            el: '#app',
            data: {
                flights: [],
                crews: [],
                api_root: '/api/'
            },
            created() {
                let url = this.api_root + 'flights.json'

                fetch(url)
                    .then((response) => response.json())
                    .then((response) => {
                        this.flights = response
                        console.log('flights', this.flights)
                    })
                    .catch((error) => {
                        console.log(error);
                    })
               
                url = this.api_root + 'crew.json'
                fetch(url)
                    .then((response) => response.json())
                    .then((response) => {
                        this.crews = response
                        console.log('crews', this.crews)
                    })
                    .catch((error) => console.log(error))

            },
            methods: {
                crewName: function (crew_id) {
                    if (crew_id === null)
                        return ''
                    let crew
                    for (crew of this.crews)
                        if (crew.id === crew_id)
                            return crew.captainsName + " " + crew.captainsSurname
                },
                patchCrew: function (data) {
                    
                    let flight = data.flight
                    let crew = data.crew
                    if (crew != flight.crew) {
                        let url = this.api_root + 'flights/' + flight.id + '/'
                        let fetchData = {
                            method: 'PATCH',
                            body: JSON.stringify({
                                "crew": crew
                            }),
                            headers: {
                                "Accept": "application/json",
                                'content-type': 'application/json',
                            },
                        }
                        fetch(url, fetchData)
                            .then((response) => {
                                console.log(response)
                                if (response.status === 400)
                                    alert("This crew is busy!")
                                if (response.status === 401)
                                    alert("You need to bo logged in to set crew. Head to localhost:8000/auth/login.")
                                if (response.ok === false)
                                    return ''
                                return response.json()
                            })
                            .then((data) => {
                                if (data != '') {
                                    newFlight = flight
                                    newFlight.crew = crew
                                    Vue.set(this.flights, this.flights.indexOf(flight), newFlight)
                                }
                            })
                            .catch((error) => console.log(error))
                        }

                },
                postCrew: function(data) {
                    if (data.captainsName === '' || data.captainsSurname === '')
                        alert('Make sure to write both name and surname!')
                    console.log(data, JSON.stringify(data))
                    let fetchData = {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: {
                            "Accept": "application/json",
                            'content-type': 'application/json',
                        },
                    }
                    let url = this.api_root + 'crew/'

                    fetch(url, fetchData)
                        .then((response) => {
                            console.log(response)
                            if (response.status === 400)
                                alert("This name and surname are already in use!")
                            if (response.status === 401)
                                alert("You need to bo logged in to create new crew. Head to localhost:8000/auth/login.")
                            if (response.ok === false)
                                return ''
                            return response.json()
                        })
                        .then((data) => {
                            if (data != '')
                                this.crews.push(data)
                        })
                        .catch((error) => console.log(error))
                }
            }
        })
     </script>
</body>
</html>